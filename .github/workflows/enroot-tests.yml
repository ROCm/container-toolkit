name: Enroot Tests

on:
  workflow_dispatch:
    inputs:
      test_name:
        description: 'Select test to run'
        required: true
        type: choice
        options:
          - test_single_node_pytorch
          - test_multi_node_distributed_pytorch
      no_install:
        description: 'Skip installation (--no-install)'
        required: false
        type: boolean
        default: false
      no_uninstall:
        description: 'Skip uninstallation (--no-uninstall)'
        required: false
        type: boolean
        default: false
      docker_image:
        description: 'Docker image to use (default: rocm/pytorch:latest for single-node, docker://rocm/pytorch:rocm7.0.2_ubuntu22.04_py3.10_pytorch_release_2.7.1 for multi-node)'
        required: false
        type: string
        default: ''

jobs:
  run-enroot-tests:
    runs-on: enroot-runners
    timeout-minutes: 120
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'
      
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install -r tests/enroot/requirements.txt
      
      - name: Run enroot tests
        working-directory: tests/enroot
        run: |
          python3 run_test.py "${{ inputs.test_name }}" "${{ inputs.docker_image }}" "${{ inputs.no_install }}" "${{ inputs.no_uninstall }}"
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ inputs.test_name }}-${{ github.run_number }}
          path: tests/enroot/results/
          if-no-files-found: warn
          retention-days: 30
